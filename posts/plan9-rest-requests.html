<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en_US" xml:lang="en_US">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plan 9: REST requests using the filesystem (seriously)</title>
<meta name="author" content="Lucas S. Vieira" />
<meta name="description" content="Programming, Tech, and occasional rant space by Lucas Vieira" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-22RF3F5XE0"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-22RF3F5XE0');
</script>
<link rel="stylesheet" type="text/css" href="../css/main.css" />
<link rel="stylesheet" type="text/css" href="../css/syntax.css" />
<link id="theme-css" rel="stylesheet" type="text/css" href="../css/dark-theme.css" />
<link rel="icon" type="image/jpg" href="../img/cat-i-mage.jpg" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta property="og:image" content="../img/cat-i-mage.jpg">
<meta name="theme-color" content="#14171e">
</head>
<body>
<div id="preamble" class="status">
<nav><h1><a href="../">The Alchemist's Hideout</a></h1></nav><h1 class="title">Plan 9: REST requests using the filesystem (seriously)</h1><p><i>Written in Apr 07, 2024 by Lucas S. Vieira<br/><a href="mailto:lucasvieira@protonmail.com">lucasvieira@protonmail.com</a></i></p>
</div>
<div id="content" class="content">
<div class="org-center">

<div id="orgd458397" class="figure">
<p><img src="img/space-glenda.png" alt="space-glenda.png" />
</p>
<p><span class="figure-number">Figure 1: </span>I can't just make a Plan 9 article without a Glenda picture, right?</p>
</div>
</div>

<p>
Lately I've  been porting the Minerva  System, which was originally  built using
Rust, to Golang.
</p>

<p>
But you probably don't know what <a href="https://minerva-system.github.io/minerva-system/">Minerva  System</a> is. Well, it is a project built
solely with the purpose of study  and&#x2026; overengineering. It is somewhat modeled
after an ERP &#x2013; since I've spent more time maintaining ERPs and dealing with its
many  business  rules than  recommended  for  my health  &#x2013;,  I  thought that  a
microservice-like attempt  at building an ERP  was the best place  to experiment
with new technology I wished to learn. <a href="https://github.com/Minerva-System/minerva-system">So I programmed it using the Rust
language</a>, and it was fun for a while.
</p>

<p>
However, ERPs require time  and can be hard to deal with.  More than that, using
microservices "because  I can"  certainly made it  infinitely harder.   Add some
Rust and gRPC&#x2026; even more time needed.
</p>

<p>
But  this project  was  fun nonetheless,  and  even spawned  a  few other  crazy
subprojects. <a href="https://git.sr.ht/~luksamuk/minerva9">I was recently looking at an old attempt of mine at building a GUI
for the Minerva  System</a>, more specifically for the Rust  version. It was built
using  <a href="https://git.sr.ht/~ft/microui">a   port  of   <code>microui</code></a>  for   an  operating   system  called   Plan  9.
Because&#x2026; well,  I'm not really into  front-end web development, so  I might as
well always do things the hardest way I can. :P
</p>


<div id="org4ba6683" class="figure">
<p><img src="img/webfs-minerva-microui.png" alt="webfs-minerva-microui.png" width="800" />
</p>
<p><span class="figure-number">Figure 2: </span>I don't care what other people think, it looks good in my eyes. :^)</p>
</div>

<p>
This GUI had two characteristics which  I enjoyed exploring. First: it was built
using Plan 9 C (which is basically<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup> C, but not POSIX-compliant). Second: to
perform connections with the REST API, <b><span class="underline">I used Plan 9's own filesystem for HTTP
requests</span></b>.
</p>

<p>
Let that sink in for a bit.
</p>

<p>
I did not install any libraries. I did not have any REST or HTTP clients at hand
to perform requests.  I  also did not open any sockets  (although Plan 9 doesn't
have sockets<sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup>).  I simply  used a  bunch of special  directories and  files which
interact with a service running on the background.
</p>

<p>
This opens  up a  lot of  possibilities, and  this is  also part  of the  Plan 9
philosophy.  Got access  to the  filesystem?  Can you  see the  resource in  the
filesystem also? Voilà, you get free access. I mean&#x2026; maybe. I don't wanna just
oversimplify things.
</p>

<p>
For this post, I wanted to explore a little bit of how the <code>webfs</code> service works
and how one  can perform HTTP requests  using it, especially to a  REST API just
like I did before.
</p>
<div id="outline-container-org1fe54f7" class="outline-2">
<h2 id="org1fe54f7">Exploring <code>webfs</code></h2>
<div class="outline-text-2" id="text-org1fe54f7">
<p>
Let's start with the basics. According to  its own manpage on Plan 9, <a href="https://man.9front.org/4/webfs"><code>webfs(4)</code></a>
is a tool that <span class="underline">"presents a file  system interface to the parsing and retrieving
of URLs"</span>. There  isn't much to explain  about what it is, except  maybe that it
relies on the <a href="https://en.wikipedia.org/wiki/9P_(protocol)">9P protocol</a>, which is kind of a big deal: even though the original
developers of Plan 9  have moved on a long time ago, 9P  is so important that it
is currently used on modern features such as WSL2 on Windows<sup><a id="fnr.3" class="footref" href="#fn.3" role="doc-backlink">3</a></sup>.
</p>

<p>
<code>webfs(4)</code> normally is also used  with <a href="https://man.9front.org/4/webcookies"><code>webcookies(4)</code></a>, which is another service
for&#x2026; well, managing cookies.  But we won't need to work  with cookies here, so
we can ignore <code>webcookies(4)</code> now.
</p>

<p>
To  run   <code>webfs(4)</code>,  you'll  need  Plan   9  (of  course),  and   an  internet
connection. <a href="./plan9-setup-rpi.html">On  this old tutorial</a>,  I go step by  step on configuring  <a href="https://9front.org">9front</a> (a
fork of  Plan 9 which is  still being maintained)  on a Raspberry Pi  3B+, which
should provide a head start if  you're interested.  Afterwards, you just need to
grab an IP for your machine on your local network:
</p>

<div class="org-src-container">
<pre class="src src-rc">ip/ipconfig
</pre>
</div>

<p>
Finally, you can start <code>webfs(4)</code>  (and <code>webcookies(4)</code>, which should be started
before <code>webfs(4)</code>).
</p>

<div class="org-src-container">
<pre class="src src-rc"><span style="color: #9d81ba;">if</span>(<span style="color: #e55c7a;">!</span> webcookies &gt;[<span style="color: #f5c791;">2</span>]/dev/null)
        webcookies -f /tmp/webcookies
webfs
</pre>
</div>

<p>
Generally, I  put these commands on  my <code>$home/lib/profile</code> file, so  that every
time  I start  a session  or turn  on my  Raspberry Pi,  I have  both a  working
internet connection  and easy  access to  web browsing on  any web  browser that
depends on <code>webfs</code> (such as <code>mothra(1)</code> or <code>abaco(1)</code>).
</p>


<div id="org064d050" class="figure">
<p><img src="img/webfs-mothra.png" alt="webfs-mothra.png" width="500" />
</p>
<p><span class="figure-number">Figure 3: </span>This blog is 100% viewable on <a href="https://man.9front.org/1/mothra"><code>mothra(1)</code></a>, satisfaction guaranteed.</p>
</div>


<div id="orgc3a7afb" class="figure">
<p><img src="img/webfs-abaco.png" alt="webfs-abaco.png" width="500" />
</p>
<p><span class="figure-number">Figure 4: </span><a href="https://man.9front.org/1/abaco"><code>abaco(1)</code></a> is old stuff that nobody should use, but may work on some cases.</p>
</div>


<div id="org50dd567" class="figure">
<p><img src="img/webfs-netsurf.png" alt="webfs-netsurf.png" width="500" />
</p>
<p><span class="figure-number">Figure 5: </span><code>netsurf</code> will make you a lot happier, but you'll have to compile it from source.</p>
</div>
</div>
</div>
<div id="outline-container-orgd3b47dd" class="outline-2">
<h2 id="orgd3b47dd">The <code>/mnt/web</code> directory</h2>
<div class="outline-text-2" id="text-orgd3b47dd">
<p>
After you run <code>webfs</code>, you get a mount point at <code>/mnt/web</code>, which can be used as
interface for our requests.
</p>

<p>
<code>/mnt/web</code> starts with an hierarchical directory,  and if you didn't do anything
yet, you should see only the <code>clone</code> and <code>ctl</code> files.
</p>


<div id="org2dbd2f3" class="figure">
<p><img src="img/webfs-1.png" alt="webfs-1.png" width="500" />
</p>
</div>

<p>
These files  are special, in  the sense that they're  not simple text  files. We
should think of them as streams &#x2013; interfaces to the <code>webfs</code> service.
</p>
</div>
<div id="outline-container-org0c907da" class="outline-3">
<h3 id="org0c907da">Global parameters: the <code>ctl</code> file.</h3>
<div class="outline-text-3" id="text-org0c907da">
<p>
<code>ctl</code> is  such a special  file, which exists  for maintaining parameters  of the
<code>webfs</code> service. We won't go deep into the purpose and usage of this file, so it
should suffice to know that we can use it to set and retrieve global information
such as request <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent">user-agent</a> and request timeout.   There is even a way to perform
pre-authentication so you don't have to keep using Basic-type authentication all
the time.
</p>

<p>
If you print the  <code>ctl</code> file, the currently set parameters  will be displayed on
console.
</p>


<div id="orgd21f393" class="figure">
<p><img src="img/webfs-2.png" alt="webfs-2.png" width="500" />
</p>
</div>
</div>
</div>
<div id="outline-container-org66a5969" class="outline-3">
<h3 id="org66a5969">Allocating a connection: the <code>clone</code> file</h3>
<div class="outline-text-3" id="text-org66a5969">
<p>
The most interesting file on this directory  is the <code>clone</code> file. If we open it,
then a new directory with a numbered name will be created under <code>/mnt/web</code> (I am
going to refer to said directory as <code>/mnt/web/n</code>).
</p>

<p>
Let's start  by allocating a connection.  We then immediately <code>cd</code>  into the <code>n</code>
directory:
</p>


<div id="org534b204" class="figure">
<p><img src="img/webfs-3.png" alt="webfs-3.png" width="500" />
</p>
<p><span class="figure-number">Figure 6: </span>As you can see, in this example,  <code>n</code> corresponds to the number <code>0</code>, so whenever I talk about <code>/mnt/web/n</code>, I am referring to what is, on these screenshots, the directory <code>/mnt/web/0</code>.</p>
</div>


<p>
So why did we <code>cd</code> into <code>/mnt/web/n</code>,  you may ask? Well, because this directory
represents our actual connection.  We also do this to prevent  the files in this
directory  from  being  considered  unused,   thus  closing  and  recycling  the
connection<sup><a id="fnr.4" class="footref" href="#fn.4" role="doc-backlink">4</a></sup>.
</p>
</div>
</div>
</div>
<div id="outline-container-orgbb63e58" class="outline-2">
<h2 id="orgbb63e58">Performing requests</h2>
<div class="outline-text-2" id="text-orgbb63e58">
<p>
Now we can perform  actual HTTP requests. For that, we'll  use the <a href="https://pokeapi.co/">PokéAPI</a> which
kindly provides a REST API for fetching Pokémon-related data.
</p>

<p>
To keep things  simple, we're going to  fetch a single Pokémon  from the Pokémon
list.    This     can    be     done    through     a    <code>GET</code>     request    to
<code>https://pokeapi.co/api/v2/pokemon?limit=1offset=0</code>.
</p>

<p>
Right now,  the file <code>/mnt/web/clone</code>  is equivalent to <code>/mnt/web/n/ctl</code>  in the
sense that these files  can be used to control our requests,  but we're going to
use <code>/mnt/web/n/ctl</code> for a visual effect.
</p>

<p>
First things  first, we simply  inform <code>webfs</code> that we  want to perform  a <code>GET</code>
request to the given  URL. This can be done through two  parameters, and we pass
these parameters to <code>webfs</code> by writing them, one by one, to <code>/mnt/web/n/ctl</code>.
</p>


<div id="orgbff9b14" class="figure">
<p><img src="img/webfs-4.png" alt="webfs-4.png" width="500" />
</p>
</div>

<p>
<b><b>NOTE:</b></b> If we  were performing a request  that needs a body, such  as a common
<code>POST</code> or <code>PUT</code> request would require, right  now we could write the body to the
<code>postbody</code> file. No special magic required here, just be mindful of the data you
write there.
</p>
</div>
<div id="outline-container-orgc7d1e57" class="outline-3">
<h3 id="orgc7d1e57">Extracting request data</h3>
<div class="outline-text-3" id="text-orgc7d1e57">
<p>
Let's stop  here for a moment.  We're ready to  perform our request, but  we can
also use <code>webfs(4)</code> to parse our URL for us if we're using, for example, <a href="http://man.9front.org/1/rc"><code>rc(1)</code></a>
to execute a script that does something web-related.
</p>

<p>
The parts of our request can be seen on the <code>/mnt/web/n/parsed/</code> directory. This
directory contains a lot of files which are rather useful.
</p>


<div id="org6fe999d" class="figure">
<p><img src="img/webfs-5.png" alt="webfs-5.png" width="500" />
</p>
</div>

<p>
Let's explore these files in greater detail:
</p>

<ul class="org-ul">
<li><code>fragment</code>: The portion of the URL separated by the <code>#</code> character, if existing
(e.g.   if you're  jumping to  a  certain heading  on the  current page  while
browsing).</li>
<li><code>host</code>: Host address of the server.</li>
<li><code>user</code>, <code>passwd</code>: Basic authentication data, if informed.</li>
<li><code>path</code>: Route of resource on host, if informed.</li>
<li><code>port</code>: Port you're trying to access on the server, if informed.</li>
<li><code>query</code>:  Query parameters;  the portion  separated by  the <code>&amp;</code>  character, if
existing  (e.g. if  you're trying  to pass  pagination parameters  through the
URL).</li>
<li><code>scheme</code>: HTTP, HTTPS, etc.</li>
<li><code>url</code>: Echoes back the used URL.</li>
</ul>


<div id="org70be6cf" class="figure">
<p><img src="img/webfs-6.png" alt="webfs-6.png" width="500" />
</p>
</div>
</div>
</div>
<div id="outline-container-orgcb15726" class="outline-3">
<h3 id="orgcb15726">Performing the actual request</h3>
<div class="outline-text-3" id="text-orgcb15726">
<p>
The next  step is performing  the request. Again, there  is no magic  here: just
open  the  file  <code>/mnt/web/n/body</code>  for  reading.  This  is  a  once-per-request
operation, and it <b><b>will</b></b> reset our request parameters after it is done:
</p>


<div id="org8fe0b5c" class="figure">
<p><img src="img/webfs-7.png" alt="webfs-7.png" width="500" />
</p>
</div>

<p>
Let's take a better  look at the response. I've isolated  and formatted what was
echoed:
</p>

<div class="org-src-container">
<pre class="src src-json">{
    <span style="color: #9d81ba;">"count"</span>: <span style="color: #f5c791;">1302</span>,
    <span style="color: #9d81ba;">"next"</span>: <span style="color: #f5c791;">"https://pokeapi.co/api/v2/pokemon?offset=1&amp;limit=1"</span>,
    <span style="color: #9d81ba;">"previous"</span>: <span style="color: #0D9C94;">null</span>,
    <span style="color: #9d81ba;">"results"</span>: [
        {
            <span style="color: #9d81ba;">"name"</span>: <span style="color: #f5c791;">"bulbasaur"</span>,
            <span style="color: #9d81ba;">"url"</span>: <span style="color: #f5c791;">"https://pokeapi.co/api/v2/pokemon/1/"</span>
        }
    ]
}
</pre>
</div>

<p>
Ok, that  seems pretty good. But  wait, what if  we wanted to view  the response
again?
</p>


<div id="org587768e" class="figure">
<p><img src="img/webfs-8.png" alt="webfs-8.png" width="500" />
</p>
</div>

<p>
Oops. It attempts to  perform the request once again, but now  we need to supply
request data once more (as you can see, it complains that <span class="underline">no url is set</span>).
</p>
</div>
</div>
<div id="outline-container-org82e0e72" class="outline-3">
<h3 id="org82e0e72">Exploring response headers</h3>
<div class="outline-text-3" id="text-org82e0e72">
<p>
Let's do everything all over again. We'll supply all the parameters, perform the
request, and then we'll look again at our <code>/mnt/web/n/</code> directory.
</p>


<div id="orgc89e662" class="figure">
<p><img src="img/webfs-9.png" alt="webfs-9.png" width="500" />
</p>
</div>

<p>
Uh, what the heck, where did all these files come from?
</p>

<p>
Well, it's  pretty simple:  all the  <a href="https://developer.mozilla.org/en-US/docs/Glossary/Response_header">response headers</a> are  parsed just  like our
request parameters were parsed in the  <code>parsed</code> directory. But for the response,
<code>webfs</code> simply creates a new file on <code>/mnt/web/n/</code> for each received header.
</p>

<p>
You'll also notice that the headers have  funny names. This is because they were
stripped of  hyphens (<code>-</code>),  so a  header such  as <code>access-control-allow-origin</code>
would become <code>accesscontrolalloworigin</code>.
</p>

<p>
For the sake of  comparison, let's take a look at those  headers when we perform
such a request on Linux by using <code>curl</code>.
</p>

<div class="org-src-container">
<pre class="src src-bash">curl https://pokeapi.co/api/v2/pokemon<span style="color: #f5c791;">\?</span>limit<span style="color: #f5c791;">\=</span><span style="color: #f5c791;">1</span><span style="color: #f5c791;">\&amp;</span>offset<span style="color: #f5c791;">\=</span><span style="color: #f5c791;">0</span> -vvv
</pre>
</div>


<div id="org424f694" class="figure">
<p><img src="img/webfs-curl-compare.png" alt="webfs-curl-compare.png" width="500" />
</p>
</div>

<p>
You'll  find  on the  screenshot  above  that the  request  data  are the  lines
beginning  with an  <code>&gt;</code>, and  the response  data begins  with a  <code>&lt;</code>. Among  the
response lines, after <code>&lt; HTTP/2 200</code>, you'll see every response header received.
</p>
</div>
</div>
</div>
<div id="outline-container-org4252ce6" class="outline-2">
<h2 id="org4252ce6">What if something goes wrong?</h2>
<div class="outline-text-2" id="text-org4252ce6">
<p>
Suppose that we attempt to perform a request to a resource that does not exist:
</p>


<div id="orgb61f356" class="figure">
<p><img src="img/webfs-10.png" alt="webfs-10.png" width="500" />
</p>
</div>

<p>
Just like in the  example where no URL was set, we get  an error. But this time,
we can see that the error string is  a bit different &#x2013; we actually get an error
code we can  deal with.
</p>

<p>
To work with this error string, we'd have to get output from the <code>stderr</code> stream
(as  opposed to  the  default, <code>stdout</code>,  which is  basically  the main  console
output). If you're using the C language,  Plan 9 C has useful language functions
such as  <a href="http://man.9front.org/2/errstr"><code>errstr(2)</code></a> and constants such  as <code>ERR_MAX</code> for handling  these &#x2013; and
trust me, this is easier to do in C than it seems at first sight.
</p>

<p>
So now  you can probably  work with most request  with ease, even  handling HTTP
error codes.
</p>
</div>
</div>
<div id="outline-container-org7b167a7" class="outline-2">
<h2 id="org7b167a7">Conclusion</h2>
<div class="outline-text-2" id="text-org7b167a7">
<p>
I always  thought that  this approach  was an inspiration.  Of course  using the
filesystem has its  problems, especially if you're looking for  speed, but 9P is
still a very good protocol that provides decent speed for most cases.
</p>

<p>
Using the filesystem  as a web interface  is also interesting in  the sense that
this is  language-agnostic. You only  need to run  a specific service,  and this
service works for any application that might depend on it.  <a href="https://en.wikipedia.org/wiki/Unix_philosophy">It does what it
should do &#x2013; and does it well</a>.
</p>

<p>
Of course, there are flaws on <code>webfs(4)</code>.  For example, I am still not sure what
to do  when you want  to handle  other HTTP codes  for <b>success</b> cases,  e.g. if
you're returning <code>201  Created</code> for a resource. In these  cases, the <code>body</code> file
will open just fine, but the actual HTTP code goes to the limbo. I guess this is
irrelevant for most cases, but this  small feature is missing, after all. Unless
I'm the one who missed something from the manpages.
</p>

<p>
Furthermore, handling  HTTP error responses is  a little complicated on  my end,
since I generally design my APIs to  return response bodies on error cases. This
is one more thing I simply could not  do at all: retrieve the response body when
the API returns an HTTP error code. <code>stderr</code> is all you get and that's it.
</p>

<p>
Welp, easier  said than done, right?  Though I suppose  it can't be too  hard to
make patches for  9front fixing these issues.   I might just do  that whenever I
can.
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
By "basically",  I mean  that  it's fine  for anyone  acquainted with  C
development.  But  C development  in  Plan  9  is  still different  enough  than
"ordinary" C for compilers  such as GCC or Clang, and why not  say this, is also
much simpler.
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
You really  don't get access to sockets  in Plan 9, at least  that I know
of. For your networking  needs in C, you'll be using <a href="https://man.9front.org/2/dial"> <code>dial(2)</code></a>, and frankly, it
is much more elegant.
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3" role="doc-backlink">3</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://devblogs.microsoft.com/commandline/whats-new-for-wsl-in-windows-10-version-1903/">As stated here</a>, WSL2 has been modified to start a 9P server, with Windows
acting as  a client. This  is how  you're able to  access your WSL's  files from
Windows Explorer.
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4" role="doc-backlink">4</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
According to <code>webfs(4)</code> manpage, the  connection is recycled when all the
files  in <code>/mnt/web/n</code>  are  closed,  so I  suppose  <code>cd</code>'ing into  <code>/mnt/web/n</code>
prevents that at this point. But I am not sure of that&#x2026; I couldn't really find
anything on this behaviour on the <code>rc(1)</code>  shell manpage, but it seemed to work,
so bear with me for a while.
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<h3><a href="../">Back to last page</a></h3>
</div>
</body>
</html>
